---
title: 'Reproducing Manuscript Figures'
date: '`r Sys.Date()`'
author:
- name: 'Helena Winata'
  email: 'hwinata@mednet.ucla.edu'
output: rmarkdown::html_vignette
vignette: > 
  %\VignetteIndexEntry{Reproducing Manuscript Figures}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, echo=FALSE, message=FALSE}
# rmarkdown::render('/hot/code/hwinata/GitHub/uclahs-cds/public-R-CancerEvolutionVisualization/vignettes/example.Rmd');

library(knitr)
# library(CancerEvolutionVisualization);
devtools::load_all('/hot/code/hwinata/GitHub/uclahs-cds/public-R-CancerEvolutionVisualization');
# devtools::load_all('/hot/code/hwinata/GitHub/uclahs-cds/cev-temp');
knitr::opts_chunk$set(warning = FALSE, message = FALSE);

if (!dir.exists('figures')) dir.create('figures');
```

# Introduction
This vignette demonstrates how to reproduce the figures presented in our manuscript 'CEV: A Tool for Standardized Cancer Evolution Visualization' using the CEV package. We will walk through the generation of each figure using example datasets provided with the package. The code snippets below show how to create customized phylogenetic trees, CCF heatmaps, and other visualizations that highlight different aspects of tumor evolution. Users can easily adapt these examples to their own datasets by following the same workflow and customization options.

# Input Data
```{r echo=FALSE}
load('data/SNV.rda');
load('data/multi.phylogeny.rda');
load('data/single.phylogeny.rda');

# process multi phylogeny data
rownames(multi.phylogeny) <- multi.phylogeny$label;
multi.phylogeny[c('3', '11'), ] <- multi.phylogeny[c('11', '3'), ];
multi.phylogeny$spread[multi.phylogeny$parent == which(multi.phylogeny$label == '3')] <- 1.3;
multi.phylogeny$spread[multi.phylogeny$parent == which(multi.phylogeny$label == '7')] <- 0.4;
rownames(multi.phylogeny) <- multi.phylogeny$label;

# process single phylogeny data
rownames(single.phylogeny) <- single.phylogeny$node.id <- single.phylogeny$label;
```

```{r echo=F}
kable(
    x = head(snv),
    caption = 'Mutation-to-subclone assignment data.'
    );

kable(
    x = single.phylogeny,
    caption = 'Example phylogeny data for a single tumour sample.'
    );
```

```{r plot-params, echo=F}
clone.col <- setNames(
    c('#a90000', '#e20000', '#f42404', '#df6b0b', '#f48004', '#f2a123', '#d7c454', '#90de3a', '#5ecf1c', '#37a400', 
   '#158800', '#16a149', '#1ecfa9', '#05f8f2', '#00daff', '#00abff', '#007dff', '#004aff', '#1922ff', '#5703ff', 
   '#8600ff', '#ab19ff', '#bd4cff', '#de56fc', '#f43ded', '#ff00d1'),
   c('MRCA', 1:25)
    );

spatial.col <- setNames(
    c('#A1D59C', '#BEA0CE', '#722A7F'),
    c('Primary', 'Shared', 'Metastasis')
    );
```

\pagebreak

# Multi-sample Plots

## CCF Heatmap
```{r ccf-hm}
create.cluster.heatmap(
    filename = 'figures/1B_CCF-heatmap.png',
    DF = snv,
    ccf.limits = c(0, 1),
    clone.colours = clone.col,
    ylab.label = 'Sample',
    ylab.cex = 1.2,
    yaxis.cex = 1,
    y.spacing = -0.2,
    height = 7,
    width = 11
    );
```

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('figures/1B_CCF-heatmap.png');
```

\pagebreak

## Summary Heatmap
```{r summary-hm}
# Calculate median CCF per sample
median.ccf <- aggregate(CCF ~ ID + clone.id, data = snv, FUN = median);
names(median.ccf)[names(median.ccf) == 'CCF'] <- 'median.ccf.per.sample';

# Calculate total unique SNV.id per sample
total.nsnv <- aggregate(
    SNV.id ~ ID + clone.id,
    data = snv,
    FUN = function(x) length(unique(x))
    );
names(total.nsnv)[names(total.nsnv) == 'SNV.id'] <- 'total.nsnv';


# Merge the results back to the original data frame
snv <- merge(snv, median.ccf, by = c('ID', 'clone.id'));
snv <- merge(snv, total.nsnv, by = c('ID', 'clone.id'));

create.ccf.summary.heatmap(
    filename = 'figures/1C_CCF-summary-heatmap.png',
    DF = snv,
    ccf.limits = c(0, 1),
    clone.colours = clone.col,
    clone.order = levels(snv$clone.id),
    sample.order = levels(snv$ID),
    y.spacing = c(-0.5, -2.5),
    xlab.axis.padding = c(0, 0, -2),
    plot.objects.heights = c(0.3, 1, 0.25),
    height = 7,
    width = 11
    );
```

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('figures/1C_CCF-summary-heatmap.png');
```

\pagebreak

## Clone Genome Distribution Plot
```{r clone-genome-dist, message=FALSE}
selected.clone <- c('1', subset(multi.phylogeny, spatial %in% c('Shared', 'Metastasis'))$label)
sub.dt <- droplevels(snv[snv$clone.id %in% selected.clone, ]);

create.clone.genome.distribution.plot(
    filename = 'figures/1D_clone-genome-distribution.png',
    snv.df = sub.dt,
    clone.order = levels(sub.dt$clone.id),
    clone.colours = clone.col,
    legend.y = 0.47,
    legend.x = 0.1,
    y.spacing = -0.5,
    alpha = 0.6,
    ylab.axis.padding = c(-1),
    width = 26,
    );
```
```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('figures/1D_clone-genome-distribution.png');
```

## Multi-sample Phylogenetic Tree
```{r phylo-tree-prep, echo=F}
phy.dt <- multi.phylogeny;
phy.dt$spatial <- phy.dt$length.1 <- phy.dt$length.2 <-  NULL;
```

```{r phylo-tree, fig.dim=c(5, 5)}
# SRCGrob(
#     phy.dt,
#     add.normal = TRUE,
#     scale1 = 2,
#     horizontal.padding = 1,
#     ) |> grid.draw();
create.phylogenetic.tree(
    filename = 'figures/1G_multi-sample-phylogeny.png',
    phy.dt,
    add.normal = TRUE,
    scale1 = 2,
    horizontal.padding = 1,
    height = 7,
    width = 7
    );
```
```{r echo=FALSE, out.width='50%'}
knitr::include_graphics('figures/1G_multi-sample-phylogeny.png');
```

### Highlighting sample-specific subclones
```{r phylo-tree-sample, fig.width=4, fig.height=4}
R7.dt <- subset(snv, ID == 'R7' & CCF > 0);
cp.dt <- aggregate(CCF ~ clone.id, data = R7.dt, FUN = function(x) median(x, na.rm = TRUE))
names(cp.dt) <- c('label', 'node.size');
cp.dt$node.col <- clone.col[cp.dt$label];

cp.dt <- merge(
    x = phy.dt,
    y = cp.dt,
    all.x = TRUE
    );

rownames(cp.dt) <- cp.dt$label;
idx <- !(cp.dt$label %in% unique(R7.dt$clone.id));
cp.dt$edge.type.1[idx] <- 'dotted';
cp.dt$edge.width.1[idx] <- 1;
cp.dt$node.size[idx] <- 0.8;
cp.dt$node.col[idx] <- 'white';
cp.dt$node.label.col[idx] <- 'grey';
cp.dt$border.type[idx] <- 'dotted';
cp.dt$label[cp.dt$node.size <= 0.5] <- '';

kable(cp.dt);

SRCGrob(
    cp.dt,
    scale1 = 2,
    add.normal = TRUE
    ) |> grid.draw();
```